<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <title>Questionnaire</title>
    <py-config>
      packages = ["numpy", "pandas", "asyncio"]
    </py-config>
  </head>
  <body>
    <div class="jumbotron">
      <h1>SPK 2023 - Tim Anemo</h1>
      <p class="lead">
        Sistem Pendukung Keputusan Memilih Kota untuk Tempat Tinggal dengan Metode AHP-PROMETHEE
      </p>
    </div>
    <div class="container d-flex-center">
      <div>
        <h1 id="pseudo">Which of these would you prioritise?</h1>
        <form onsubmit="return false">
          <div class="mb-3">
            <label id="pair" for="pair" class="form-label"></label>
            <div class="form-check-group">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pair" id="option1" value="9">
                <label class="form-check-label" for="option1" id="option1label"></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pair" id="option2" value="5">
                <label class="form-check-label" for="option2" id="option2label"></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pair" id="option3" value="1">
                <label class="form-check-label" for="option3" id="option3label"></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pair" id="option4" value="1/5">
                <label class="form-check-label" for="option4" id="option4label"></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pair" id="option5" value="1/9">
                <label class="form-check-label" for="option5" id="option5label"></label>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" py-click="next_pair()">Next</button>
        </form>
        <div id="result"></div>
        <div id="promethee"></div>
      </div>
    </div>
    <py-script>
      from js import document
      import numpy as np
      import pandas as pd
      import asyncio
      import js
      from js import document
      from pyodide.http import open_url

      url = "https://raw.githubusercontent.com/abdzufar/pyscriptfiles/main/master_final.csv"
      url_content = open_url(url)
      df = pd.read_csv(url_content, delimiter=';')
      df = df.drop(columns=['luas_km','jumlah_penduduk'])
      
      pairwise=[]
      comparisons=[5,3,1,1/3,1/5]
      benefit_cost = np.array([1, 1, 1, 1, 1])
      criteria_list= df.columns[1:].to_numpy(dtype=str)
      weights=np.zeros(len(criteria_list))
      alternatives = df.drop(columns=['wilayah']).to_numpy(dtype=float)
      alternatives_list = df['wilayah'].to_numpy(dtype=str)
      i=0
      j=i+1
      finished=False
      def update_pairwise():
        for x in range(1,6):
            if document.querySelector("#option"+str(x)).checked:
              pairwise.append(float(comparisons[x-1]))
            document.querySelector("#option"+str(x)).checked=False

      def next_pair():
        global i,j, finished
        update_pairwise()
        if finished==True:
          document.querySelector("form").hidden=True
          AHP(pairwise)
          return

        Element('pair').write(criteria_list[i]+' or '+criteria_list[j])
        Element('option1label').write('Highly Prefer '+criteria_list[i])
        Element('option2label').write('Slightly Prefer '+criteria_list[i])
        Element('option3label').write('Neutral')
        Element('option4label').write('Slightly Prefer '+criteria_list[j])
        Element('option5label').write('Highly Prefer '+criteria_list[j])
        j+=1
        if i==len(criteria_list)-2 and j==len(criteria_list):
          i=0
          j=1
          finished=True
          return
        elif j==len(criteria_list):
          i+=1
          j=i+1          
      
      def AHP(pairwise):
        size=len(criteria_list)
        pairwise_matrix=np.zeros((size,size))
        counter=0
        for x in range(len(pairwise_matrix)):
            for y in range(len(pairwise_matrix)):
                if x==y:
                    pairwise_matrix[x,y]=1
                elif x>y:
                    pairwise_matrix[x,y]=1/pairwise_matrix[y,x]
                else:
                    pairwise_matrix[x,y]=pairwise[counter]
                    counter+=1
        
        eigen=np.zeros(size)
        for x in range(size):
            eigen[x]=np.dot(pairwise_matrix[x,:],1/pairwise_matrix.sum(axis=0))/size
        
        wsv=np.zeros(size)
        for x in range(size):
            wsv[x]=np.dot(pairwise_matrix[x,:],eigen)
        CI=(wsv.sum()-size)/(size-1)
        RI=[.52,.89,1.11,1.25,1.35,1.40,1.45,1.49,1.51,1.54,1.56]
        CR=CI/RI[size-(len(criteria_list)-1)]

        Element('result').element.innerText = "Consistency Ratio: "+str(CR)+"\nWeights: "+str(eigen)+"\npairwise_matrix: "+str(pairwise_matrix)
        Element('pseudo').write('AHP Result')
        global weights
        weights = eigen
        ranks = promethee(normalize(alternatives, benefit_cost), weights)
        print(ranks)
        for i in range(len(ranks)):
          Element('promethee').element.innerText += alternatives_list[ranks[i]]+": "+str(i)+"\n"
      next_pair()
      
      def normalize(x, benefit_cost):
        x = x.astype(float)
        col = x.shape[1]
        for i in range(col):
          if benefit_cost[i]: 
            x[:, i]=np.max(x[:, i]) - x[:, i] 
          else: 
            x[:, i]=x[:, i] - np.min(x[:, i]) 
          x[:, i]=x[:, i] / np.max(x[:, i])-np.min(x[:, i]) 
        return x
      
      def promethee(alternatives, weights):
        num_alternatives, num_criteria = alternatives.shape
        #print(alternatives)
    
        ef = np.zeros((num_alternatives))
        lf = np.zeros((num_alternatives))
    
        p_i = np.zeros((num_alternatives, num_alternatives))
    
        for i in range(num_alternatives):
          for j in range(num_alternatives):
            if i == j:
              continue

            D = []
            for k in range(num_criteria):
              alternative_i_k = alternatives[i, k]
              alternative_j_k = alternatives[j, k]
              
              D.append(alternative_i_k - alternative_j_k)

            D = np.array(D)
            D[D < 0] = 0
            D = D * weights
            #print("D"+str(i+1)+str(j+1),D)
            p_i[i,j] = D.sum()
        #print(p_i)
        lf = p_i.sum(axis=1)
        ef = p_i.sum(axis=0)
        #print("lf"+str(lf)+"\nef"+str(ef))
        net_flow = (lf/(num_alternatives-1)) - (ef/(num_alternatives-1))
        #print("nf", net_flow)
        ranks = np.argsort(net_flow)[::-1][:10]
        return ranks+1
    </py-script>
  </body>